# 🤖 POLIOM HR Assistant

[![Python Version](https://img.shields.io/badge/python-3.11-blue.svg)](https://www.python.org/)
[![Django Version](https://img.shields.io/badge/django-4.2-green.svg)](https://www.djangoproject.com/)
[![Docker](https://img.shields.io/badge/docker-powered-blue.svg)](https://www.docker.com/)

**Корпоративная система умного поиска по документам с Telegram ботом и веб-панелью управления**

Система на основе RAG (Retrieval-Augmented Generation) для автоматизации HR-процессов с использованием российских технологий: GigaChat для генерации ответов и локальных эмбеддингов для поиска.

---

## 🚀 Основные возможности

- 🤖 **Telegram бот** - мгновенные ответы сотрудникам на HR-вопросы
- 🧠 **GigaChat интеграция** - российская LLM для качественных ответов
- 📄 **Обработка документов** - PDF, DOCX, TXT с автоматической векторизацией
- 🔧 **Веб админ-панель** - управление документами, пользователями и FAQ
- 🔍 **Умный поиск** - векторный поиск с PostgreSQL + pgvector
- ⚡ **Асинхронная обработка** - Celery для фоновых задач
- 🐳 **Контейнеризация** - полная Docker-изация для простого развертывания
- 🏢 **Локальная сеть** - работа без интернета в корпоративной среде

---

## 🛠️ Технологический стек

-   **Backend**: Python, Django 4.2
-   **Telegram Бот**: Aiogram 3
-   **База данных**: PostgreSQL
-   **Кэширование и фоновые задачи**: Redis, Celery
-   **ML/NLP**: GigaChat API, LangChain, FAISS
-   **Контейнеризация**: Docker, Docker Compose

---

## 📋 Системные требования

### Минимальные требования:
- **ОС**: Windows 10/11, Linux, macOS
- **RAM**: 4 GB (рекомендуется 8 GB)
- **Диск**: 10 GB свободного места
- **Docker**: Docker Desktop 4.0+
- **Сеть**: Локальная сеть (интернет нужен только для первоначальной настройки)

### Необходимые ключи:
- **Telegram Bot Token** (бесплатно от @BotFather)
- **GigaChat API Key** (бесплатно для физлиц)

---

## 🏁 Начало работы

Этот раздел содержит инструкции по запуску проекта для двух сценариев: локальная разработка и развертывание на production-сервере.

### 👨‍💻 Для разработчиков (локальный запуск)

Эти шаги предназначены для настройки и запуска проекта на локальной машине для разработки и тестирования.

**1. Требования:**
   - [Docker](https://www.docker.com/products/docker-desktop/)
   - [Docker Compose](https://docs.docker.com/compose/install/)

**2. Настройка:**
   - **Клонируйте репозиторий.**
   - **Создайте файл конфигурации:** Скопируйте `.env.template` в новый файл `.env.local`:
     ```bash
     cp .env.template .env.local
     ```
   - **Заполните `.env.local`:** Откройте файл и впишите ваши локальные ключи и пароли.

**3. Запуск:**
   - Выполните команду:
     ```bash
     docker-compose -f docker-compose.local.yml up --build -d
     ```
   - Проект будет доступен через несколько минут. Админ-панель: `http://localhost:8000`.

### 👷‍♂️ Для администраторов (развертывание на сервере)

Эти шаги предназначены для развертывания проекта на production-сервере.

**1. Требования:**
   - **Docker**
   - **Docker Compose**

**2. Настройка:**
   - **Клонируйте репозиторий:**
     ```bash
     git clone <your-repository-url>
     cd <your-project-directory>
     ```
   - **Создайте файл конфигурации:** Скопируйте `.env.template` в `.env.prod`:
     ```bash
     cp .env.template .env.prod
     ```
   - **Заполните `.env.prod`:**
     Откройте файл и впишите **production-значения** (токены, надежные пароли и т.д.).
     > **ВАЖНО:**
     > - `POSTGRES_USER` и `POSTGRES_PASSWORD`: Придумайте надежные имя пользователя и пароль для базы данных.
     > - `DATABASE_URL`: Обновите эту строку в соответствии с вашими `POSTGRES_USER` и `POSTGRES_PASSWORD`.

**3. Сборка и запуск:**
   - **Соберите Docker-образы:**
     ```bash
     docker-compose -f docker-compose.prod.yml build
     ```
   - **Запустите проект в фоновом режиме:**
     ```bash
     docker-compose -f docker-compose.prod.yml up -d
     ```

**4. Управление и мониторинг:**
   - **Проверить статус контейнеров:**
     ```bash
     docker-compose -f docker-compose.prod.yml ps
     ```
   - **Посмотреть логи бота:**
     ```bash
     docker-compose -f docker-compose.prod.yml logs -f telegram-bot
     ```
   - **Остановить проект:**
     ```bash
     docker-compose -f docker-compose.prod.yml down
     ```

---

## 🏗️ Архитектура системы

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ Telegram Bot    │    │   Admin Panel   │    │  Celery Worker  │
│                 │    │                 │    │                 │
│ • Прием вопросов│    │ • Загрузка      │    │ • Обработка     │
│ • RAG поиск     │    │   документов    │    │   документов    │
│ • GigaChat      │    │ • Управление    │    │ • Векторизация  │
│   интеграция    │    │   FAQ           │    │ • Индексация    │
│ • FAQ меню      │    │ • Аналитика     │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
              ┌─────────────────────────────────────┐
              │           SHARED SERVICES           │
              │                                     │
              │  ┌─────────────┐  ┌─────────────┐   │
              │  │ PostgreSQL  │  │    Redis    │   │
              │  │ + pgvector  │  │             │   │
              │  │             │  │ • Кэш       │   │
              │  │ • Документы │  │ • Очереди   │   │
              │  │ • Векторы   │  │ • Сессии    │   │
              │  │ • FAQ       │  │             │   │
              │  │ • Логи      │  │             │   │
              │  └─────────────┘  └─────────────┘   │
              └─────────────────────────────────────┘
```

---

## 📁 Структура проекта

```
poliom/
├── 🚀 start_local.bat              # Быстрый запуск одним кликом
├── 🐳 docker-compose.local.yml     # Конфигурация для локальной сети
├── 🐳 docker-compose.yml           # Конфигурация для разработки
├── 🐳 docker-compose.prod.yml      # Продакшн конфигурация
├── ⚙️ .env.local                   # Настройки для локального запуска
├── ⚙️ .env                         # Основные настройки
├── 📊 init.sql                     # Инициализация базы данных
├── 🛠️ Makefile                     # Команды для разработчиков
├── 📋 requirements.txt             # Python зависимости
├── 🔧 deploy.sh / deploy.ps1       # Скрипты продакшн развертывания
├── 🔍 check_after_reboot.*         # Диагностика после перезагрузки
├── 📚 md_docs/                     # Документация
│   ├── БЫСТРЫЙ_СТАРТ.md
│   ├── INSTALL_GUIDE.md
│   └── README_DEPLOYMENT.md
├── 🌐 nginx/                       # Конфигурация веб-сервера
├── 📁 uploads/                     # Загруженные документы
└── 💻 services/                    # Исходный код
    ├── telegram-bot/               # Код Telegram бота
    ├── admin-panel/                # Код веб админ-панели
    └── shared/                     # Общие модули (RAG, модели)
```

---

## ⚙️ Конфигурация

### Основные настройки (.env.local)
```env
# Telegram бот
TELEGRAM_BOT_TOKEN=ВСТАВЬТЕ_СЮДА_ВАШ_ТОКЕН_ОТ_BOTFATHER

# GigaChat (получите свой ключ на https://developers.sber.ru/gigachat)
GIGACHAT_API_KEY=ВСТАВЬТЕ_СЮДА_ВАШ_GIGACHAT_API_KEY

# База данных (автоматически)
DATABASE_URL=postgresql://poliom_user:poliom_password_123@postgres:5432/poliom_local
REDIS_URL=redis://redis:6379/0

# Настройки RAG системы
SEARCH_LIMIT=15                    # Количество результатов поиска
SIMILARITY_THRESHOLD=0.3           # Основной порог схожести
MIN_SIMILARITY_THRESHOLD=0.25      # Минимальный порог схожести
```

### Настройки поиска
- **SEARCH_LIMIT**: Максимальное количество найденных документов (по умолчанию: 15)
- **SIMILARITY_THRESHOLD**: Порог для специальных запросов (зарплата, отпуска)
- **MIN_SIMILARITY_THRESHOLD**: Минимальный порог для обычного поиска

---

## 🛠️ Управление системой

### Основные команды

#### Windows (PowerShell):
```powershell
# Запуск системы
.\start_local.bat

# Статус контейнеров
docker-compose -f docker-compose.local.yml ps

# Логи всех сервисов
docker-compose -f docker-compose.local.yml logs -f

# Логи конкретного сервиса
docker logs rag_telegram_bot --tail 50

# Перезапуск системы
docker-compose -f docker-compose.local.yml restart

# Остановка системы
docker-compose -f docker-compose.local.yml down
```

#### Linux/macOS:
```bash
# Запуск системы
make dev

# Статус
make status

# Логи
make logs

# Остановка
make down
```

### Диагностика после перезагрузки
Если сервер был перезагружен, проверьте статус системы:

```bash
# Проверка статуса контейнеров
docker-compose ps

# Проверка логов
docker-compose logs --tail=20

# Проверка здоровья системы
docker stats --no-stream
```

---

## 📚 Использование системы

### 1. Загрузка документов
1. Откройте админ-панель: `http://ВАШ_IP:8001`
2. Войдите: `admin` / `poliom_$487%0_admin`
3. Перейдите в **"Документы"** → **"Добавить документ"**
4. Загрузите PDF, DOCX или TXT файлы
5. Дождитесь обработки (статус "Завершено")

### 2. Создание FAQ
1. В админ-панели перейдите в **"FAQ Меню"**
2. Создайте разделы (например: "Отпуска", "Зарплата", "Больничные")
3. Добавьте вопросы и ответы в каждый раздел
4. FAQ появится в боте как кнопки быстрого доступа

### 3. Использование бота
- **Умный поиск**: просто напишите вопрос боту
- **FAQ меню**: используйте кнопки для быстрых ответов
- **Команды**: `/start`, `/help`, `/menu`

---

## 🔧 Варианты развертывания

### 🏢 Локальная сеть (рекомендуется)
**Преимущества:**
- ✅ Данные остаются в офисе
- ✅ Независимость от интернета
- ✅ Полный контроль доступа
- ✅ Стоимость: 0 рублей

**Что нужно:**
- Компьютер с Docker Desktop
- Telegram бот (бесплатно)

### ☁️ Облачное развертывание
**Для продакшн использования с внешним доступом:**

#### VK Cloud (Россия)
- Kubernetes кластер: ~15,000₽/месяц
- PostgreSQL: ~8,000₽/месяц
- **Бонус**: 5,000₽ для новых пользователей

#### DigitalOcean (международный)
- Droplet 4GB: $24/месяц
- PostgreSQL: $15/месяц
- **Бонус**: $200 на 60 дней

---

## 🛡️ Безопасность

- 🔐 **Переменные окружения** - все ключи в .env файлах
- 🚫 **Непривилегированные контейнеры** - запуск без root
- 🔒 **HTTPS в продакшне** - SSL сертификаты
- ✅ **Валидация данных** - проверка всех входных данных
- ⏱️ **Rate limiting** - ограничение частоты запросов
- 📝 **Аудит действий** - логирование всех операций

---

## 📊 Мониторинг и диагностика

### Проверка здоровья системы
```bash
# Статус всех контейнеров
docker-compose ps

# Использование ресурсов
docker stats

# Логи с ошибками
docker-compose logs | grep ERROR

# Проверка базы данных
docker exec rag_postgres psql -U poliom_user -d poliom_local -c "SELECT COUNT(*) FROM documents;"
```

### Ключевые метрики
- **Время ответа бота**: < 30 секунд
- **Использование RAM**: < 4 GB
- **Размер базы данных**: зависит от количества документов
- **Статус обработки документов**: в админ-панели

---

## 🆘 Решение проблем

### Частые проблемы и решения

#### "Docker не найден"
```bash
# Установите Docker Desktop и перезагрузите компьютер
# Windows: https://www.docker.com/products/docker-desktop/
```

#### "Бот не отвечает"
```bash
# Проверьте токен в .env.local
# Проверьте логи бота
docker logs rag_telegram_bot --tail 20
```

#### "Админ-панель недоступна"
```bash
# Проверьте IP адрес
ipconfig  # Windows
ifconfig  # Linux/macOS

# Проверьте статус контейнера
docker ps | grep admin-panel
```

#### "Документы не обрабатываются"
```bash
# Проверьте Celery worker
docker logs rag_celery_worker --tail 20

# Перезапустите обработку
python restart_docs.py
```

#### "Ошибки импорта Python"
```bash
# Проверьте импорты
docker exec rag_telegram_bot python -c "from shared.utils.simple_rag import SimpleRAG; print('OK')"

# Перезапустите контейнеры
docker-compose restart
```

---

## 🔄 Обновление системы

### Обновление кода
```bash
# Остановите систему
docker-compose down

# Обновите код (git pull или замените файлы)

# Пересоберите образы
docker-compose build --no-cache

# Запустите систему
docker-compose up -d
```

### Обновление зависимостей
```bash
# Обновите requirements.txt
# Пересоберите образы
docker-compose build --no-cache
```

---

## 📈 Масштабирование

### Увеличение производительности
1. **Больше RAM**: увеличьте лимиты в docker-compose.yml
2. **Больше workers**: увеличьте количество Celery workers
3. **SSD диск**: для быстрой работы с базой данных
4. **Кэширование**: Redis уже настроен для кэширования

### Горизонтальное масштабирование
- Несколько экземпляров бота
- Кластер PostgreSQL
- Балансировщик нагрузки

---

## 🤝 Поддержка и развитие

### Документация
- 📖 **Полное руководство по развертыванию** в `COMPLETE_DEPLOYMENT_GUIDE.md`
- 🚀 **Быстрый старт** - см. раздел выше или полное руководство
- 🔧 **Все инструкции** объединены в одном файле для удобства

### Логирование
- Все действия логируются в базу данных
- Логи Docker контейнеров доступны через `docker logs`
- Структурированные логи в JSON формате

### Резервное копирование
```bash
# Автоматическое резервное копирование
make backup-db

# Ручное резервное копирование
docker exec rag_postgres pg_dump -U poliom_user poliom_local > backup.sql
```

---

## 📄 Лицензия

Проект использует открытые технологии и российские сервисы:
- **GigaChat** - российская LLM от Сбера
- **PostgreSQL** - открытая СУБД
- **Docker** - контейнеризация
- **Python** - язык программирования

---

## 🎉 Заключение

**POLIOM HR Assistant** - это готовое к использованию решение для автоматизации HR-процессов с использованием современных технологий искусственного интеллекта.

### ✅ Готово к работе:
- 🚀 **5 минут** до запуска
- 💰 **0 рублей** для локального использования  
- 🛡️ **Безопасность** корпоративных данных
- 📚 **Полная документация** и поддержка

### 🎯 Результат:
- Сотрудники получают мгновенные ответы на HR-вопросы
- HR-отдел экономит время на типовых запросах
- Знания компании структурированы и доступны 24/7
- Полный контроль над данными и процессами

---

**Удачного использования! 🚀**

## 🚀 Скрипты запуска

### Локальная разработка
- **`start_local.bat`** - Запуск системы на Windows (локально)
- **`start_local.sh`** - Запуск системы на Linux/macOS (локально)

### Продакшн развертывание  
- **`deploy.sh`** - Безопасное развертывание на Linux/macOS сервере
- **`deploy.ps1`** - Развертывание на Windows Server

### Дополнительные утилиты
- **`scripts/check_system.py`** - Python скрипт диагностики системы 

---

## 🚀 Production Deployment

Этот раздел предназначен для системных администраторов для развертывания проекта на production-сервере.

### 1. Требования

Убедитесь, что на сервере установлены:
-   **Docker**
-   **Docker Compose**

### 2. Первоначальная настройка

1.  **Клонируйте репозиторий:**
    ```bash
    git clone <your-repository-url>
    cd <your-project-directory>
    ```

2.  **Создайте файл конфигурации:**
    Скопируйте шаблон `.env.template` в новый файл `.env.prod`. Этот файл будет содержать все секретные ключи и настройки для production-среды.
    ```bash
    cp .env.template .env.prod
    ```

3.  **Заполните `.env.prod`:**
    Откройте файл `.env.prod` в текстовом редакторе и впишите все необходимые значения (токены, пароли, хосты).
    
    > **ВАЖНО:**
    > - **`SECRET_KEY`**: Сгенерируйте новый уникальный ключ для Django.
    > - **`ALLOWED_HOSTS`**: Укажите IP-адрес или доменное имя сервера, на котором будет доступна админ-панель.
    > - **`POSTGRES_USER` и `POSTGRES_PASSWORD`**: Придумайте надежные имя пользователя и пароль для базы данных.
    > - **`DATABASE_URL`**: Обновите эту строку в соответствии с вашими `POSTGRES_USER` и `POSTGRES_PASSWORD`.

### 3. Сборка и запуск

1.  **Соберите Docker-образы:**
    Эта команда соберет все сервисы согласно инструкциям в `docker-compose.prod.yml`.
    ```bash
    docker-compose -f docker-compose.prod.yml build
    ```

2.  **Запустите проект:**
    Эта команда запустит все контейнеры в фоновом режиме (`-d`).
    ```bash
    docker-compose -f docker-compose.prod.yml up -d
    ```

### 4. Проверка статуса

-   **Проверить статус всех контейнеров:**
    ```bash
    docker-compose -f docker-compose.prod.yml ps
    ```
    Все сервисы должны быть в состоянии `Up` или `running`.

-   **Посмотреть логи конкретного сервиса (например, бота):**
    ```bash
    docker-compose -f docker-compose.prod.yml logs -f telegram-bot
    ```

### 5. Доступ к сервисам

-   **Админ-панель Django:** Будет доступна по адресу `http://<your_server_ip>:8000`.
-   **Telegram Бот:** Начнет работать автоматически, если вы правильно указали токен.

### 6. Остановка проекта

Чтобы остановить все сервисы:
```bash
docker-compose -f docker-compose.prod.yml down
``` 

**Доступ:**
- **Админ-панель**: `http://192.168.1.XXX:8001`
- **PgAdmin**: `http://192.168.1.XXX:8082` (admin@poliom.local/pgadmin_poliom_2024_$secure#)
- **Бот**: Найдите в Telegram по username